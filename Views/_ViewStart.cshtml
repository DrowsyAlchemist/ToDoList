@{
    Layout = "_Layout";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    const receivedNotifications = new Set();

    document.addEventListener('DOMContentLoaded', function () {
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // Подключаемся к хабу
        connection.start()
            .then(() => {
                console.log("SignalR Connected");
            })
            .catch(err => console.error(err.toString()));

        // Логика нотификаций
        connection.on("ReceiveNotification", (message, taskId) => {

            console.log("ReceiveNotification: " + message);
            if (receivedNotifications.has(taskId)) return;
            receivedNotifications.add(taskId);

            // Вариант 1: Браузерные уведомления
            if (Notification.permission === "granted") {
                new Notification("Напоминание", { body: message });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("Напоминание", { body: message });
                    }
                });
            } else {
                console.log("denied");
            }

            // Вариант 2: Toast-уведомление
            // toastr.info(message, 'Новое уведомление', {
            //     onclick: () => window.location.href = '/Tasks/Details/' + taskId
            // });
            setTimeout(() => receivedNotifications.delete(taskId), 600000);
        });

        // Обработка ошибок подключения
        connection.onclose(async () => {
            await startConnection();
        });

        async function startConnection() {
            try {
                await connection.start();
                console.log("SignalR connection established");
            } catch (err) {
                console.log(err);
                setTimeout(() => startConnection(), 5000);
            }
        }
    });
</script>